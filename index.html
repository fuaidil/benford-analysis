<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analisis Benford APBD</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom class for entry animation */
      .fade-in-up {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.6s ease-out forwards;
      }

      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Custom scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: #64748b;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #475569;
      }
    </style>
  </head>
  <body
    class="bg-slate-900 text-slate-300 font-sans min-h-screen p-4 sm:p-6 lg:p-8 overflow-x-hidden"
  >
    <div
      class="absolute top-0 left-0 w-full h-full z-0 overflow-hidden pointer-events-none"
    >
      <div
        class="absolute top-[10%] left-[10%] w-[500px] h-[500px] bg-sky-500/10 rounded-full blur-3xl animate-pulse"
      ></div>
      <div
        class="absolute bottom-[5%] right-[5%] w-[400px] h-[400px] bg-indigo-500/10 rounded-full blur-3xl animate-pulse animation-delay-4000"
      ></div>
    </div>

    <main class="container mx-auto max-w-5xl z-10 relative">
      <header
        class="text-center mb-8 sm:mb-12 fade-in-up"
        style="animation-delay: 100ms"
      >
        <h1
          class="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-400 pb-2"
        >
          Analisis Hukum Benford
        </h1>
        <p class="text-slate-400 text-lg">
          Unggah file CSV untuk menganalisis distribusi digit data Anda.
        </p>
      </header>

      <section
        id="upload-section"
        class="bg-white/5 border border-white/10 rounded-2xl p-8 text-center cursor-pointer transition-all duration-300 hover:bg-white/10 hover:border-white/20 hover:scale-[1.02] fade-in-up"
        style="animation-delay: 200ms"
      >
        <div
          class="w-16 h-16 mx-auto mb-4 bg-sky-500/10 text-sky-400 rounded-full flex items-center justify-center border-2 border-sky-500/20 transition-transform duration-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
            />
          </svg>
        </div>
        <label
          for="csv-file-input"
          class="text-lg font-semibold text-white cursor-pointer"
        >
          Pilih atau Seret File CSV Anda ke Sini
        </label>
        <input type="file" id="csv-file-input" accept=".csv" class="hidden" />
        <p
          id="file-status"
          class="mt-4 text-sm text-slate-400 h-5 transition-all duration-300"
        >
          Belum ada file yang dipilih.
        </p>
      </section>

      <section
        id="controls-section"
        class="mt-8 bg-white/5 border border-white/10 rounded-2xl p-6 fade-in-up"
        style="animation-delay: 300ms"
      >
        <div
          class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-center"
        >
          <select
            id="analysis-type"
            disabled
            class="w-full bg-slate-800 border border-slate-700 rounded-lg py-3 px-4 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
          >
            <option value="first_digit">First Digit</option>
            <option value="second_digit">Second Digit</option>
            <option value="first_two_digits">First-Two Digits</option>
          </select>
          <select
            id="jenis-belanja"
            disabled
            class="w-full bg-slate-800 border border-slate-700 rounded-lg py-3 px-4 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
          ></select>
          <select
            id="tahun"
            disabled
            class="w-full bg-slate-800 border border-slate-700 rounded-lg py-3 px-4 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
          ></select>
          <button
            id="tampilkan-analisis"
            disabled
            class="w-full sm:col-start-2 md:col-start-4 bg-sky-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center hover:bg-sky-500 disabled:bg-slate-700 disabled:cursor-not-allowed disabled:text-slate-400 transition-all duration-300 transform hover:scale-105"
          >
            <span id="button-text">Tampilkan Analisis</span>
          </button>
        </div>
      </section>

      <section
        id="hasil-analisis"
        class="mt-12 transition-all duration-700 opacity-0 transform translate-y-8"
        style="display: none"
      >
        <h2
          id="judul-analisis"
          class="text-2xl font-bold text-center mb-8 text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-400"
        ></h2>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
          <div
            class="lg:col-span-3 bg-white rounded-2xl p-6 shadow-2xl shadow-slate-900/20"
          >
            <h3 class="text-xl font-bold text-slate-800 mb-4">
              üìà Grafik Distribusi Digit
            </h3>
            <canvas id="benford-chart"></canvas>
          </div>

          <div class="lg:col-span-2 space-y-6">
            <div
              class="bg-slate-800/50 backdrop-blur-sm border border-white/10 rounded-2xl p-6"
            >
              <h3 class="text-xl font-bold text-white mb-4">
                üìä Hasil Uji Statistik
              </h3>
              <div class="space-y-4 text-sm">
                <p id="hasil-mad"></p>
                <p id="hasil-chi-square"></p>
                <p id="hasil-z-test"></p>
              </div>
            </div>
            <div
              class="bg-slate-800/50 backdrop-blur-sm border border-white/10 rounded-2xl p-6"
            >
              <h3 class="text-xl font-bold text-white mb-4">
                ‚ö†Ô∏è Daerah dengan Anomali
              </h3>
              <div
                id="daftar-anomali"
                class="max-h-80 overflow-y-auto pr-2"
              ></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      // --- JAVASCRIPT UNTUK SEMUA LOGIKA ANALISIS (TIDAK BERUBAH) ---
      // Logika inti analisis Benford, kalkulasi, dan event listener tetap sama.
      // Yang diubah hanya fungsi yang berinteraksi dengan UI (updateUI, showFileStatus).
      const benfordDistributions = {};
      const criticalValues = {};

      function initializeConstants() {
        benfordDistributions.first_digit = {
          1: 30.1,
          2: 17.6,
          3: 12.5,
          4: 9.7,
          5: 7.9,
          6: 6.7,
          7: 5.8,
          8: 5.1,
          9: 4.6,
        };
        criticalValues.first_digit = { chi_square: 15.507, mad_divisor: 9 };
        benfordDistributions.second_digit = {
          0: 12.0,
          1: 11.4,
          2: 10.9,
          3: 10.4,
          4: 10.0,
          5: 9.7,
          6: 9.3,
          7: 9.0,
          8: 8.8,
          9: 8.5,
        };
        criticalValues.second_digit = { chi_square: 16.919, mad_divisor: 10 };
        benfordDistributions.first_two_digits = {};
        for (let i = 10; i <= 99; i++) {
          benfordDistributions.first_two_digits[i] =
            Math.log10(1 + 1 / i) * 100;
        }
        criticalValues.first_two_digits = {
          chi_square: 112.32,
          mad_divisor: 90,
        };
      }
      initializeConstants();

      const Z_CRITICAL_VALUE_ONE_SIDED = 1.645;
      const MAD_CLOSE_CONFORMITY = 0.015;
      const MAD_ACCEPTABLE_CONFORMITY = 0.022;

      let processedData = [];
      let benfordChartInstance = null;

      const fileInput = document.getElementById("csv-file-input");
      const uploadSection = document.getElementById("upload-section");
      const fileStatus = document.getElementById("file-status");
      const analysisTypeSelect = document.getElementById("analysis-type");
      const belanjaSelect = document.getElementById("jenis-belanja");
      const tahunSelect = document.getElementById("tahun");
      const analyzeButton = document.getElementById("tampilkan-analisis");
      const buttonText = document.getElementById("button-text");
      const hasilContainer = document.getElementById("hasil-analisis");
      const judulAnalisis = document.getElementById("judul-analisis");
      const hasilMad = document.getElementById("hasil-mad");
      const hasilChiSquare = document.getElementById("hasil-chi-square");
      const hasilZTest = document.getElementById("hasil-z-test");
      const daftarAnomaliContainer = document.getElementById("daftar-anomali");

      fileInput.addEventListener("change", handleFileSelect);
      analyzeButton.addEventListener("click", runAnalysis);

      uploadSection.addEventListener("click", () => fileInput.click());
      uploadSection.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadSection.classList.add(
          "bg-sky-500/20",
          "border-sky-500",
          "scale-[1.03]"
        );
      });
      uploadSection.addEventListener("dragleave", (e) => {
        e.preventDefault();
        uploadSection.classList.remove(
          "bg-sky-500/20",
          "border-sky-500",
          "scale-[1.03]"
        );
      });
      uploadSection.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadSection.classList.remove(
          "bg-sky-500/20",
          "border-sky-500",
          "scale-[1.03]"
        );
        const files = e.dataTransfer.files;
        if (
          files.length > 0 &&
          (files[0].type === "text/csv" || files[0].name.endsWith(".csv"))
        ) {
          processFile(files[0]);
        } else {
          showFileStatus("Hanya file .csv yang diizinkan!", "error");
        }
      });

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        processFile(file);
      }

      function processFile(file) {
        const loadingSpinner = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        showFileStatus(`${loadingSpinner}Memproses ${file.name}...`, "loading");

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            processedData = transformData(parseCSV(e.target.result));
            populateFilters(processedData);
            showFileStatus(
              `‚úÖ Siap menganalisis: ${
                file.name
              } (${processedData.length.toLocaleString("id-ID")} baris).`,
              "success"
            );
          } catch (error) {
            showFileStatus(`‚ùå Error: ${error.message}`, "error");
            console.error("Error processing file:", error);
          }
        };
        reader.onerror = () =>
          showFileStatus("‚ùå Gagal membaca file!", "error");
        reader.readAsText(file);
      }

      function showFileStatus(message, type) {
        fileStatus.innerHTML = message;
        fileStatus.classList.remove(
          "text-green-400",
          "text-red-400",
          "text-slate-400"
        );
        switch (type) {
          case "success":
            fileStatus.classList.add("text-green-400");
            break;
          case "error":
            fileStatus.classList.add("text-red-400");
            break;
          default:
            fileStatus.classList.add("text-slate-400");
        }
      }

      function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter((line) => line.trim() !== "");
        if (lines.length === 0) throw new Error("File CSV kosong!");
        const header = lines[0].split(",").map((h) => h.trim());
        const data = lines.slice(1).map((line) => {
          const values = line.split(",");
          const row = {};
          header.forEach((col, index) => {
            row[col] = values[index] ? values[index].trim() : "";
          });
          return row;
        });
        if (data.length === 0)
          throw new Error("Tidak ada data dalam file CSV!");
        return data;
      }

      function transformData(data) {
        const longData = [];
        const idVars = ["No.", "Nama Daerah"];
        data.forEach((row) => {
          Object.keys(row).forEach((columnName) => {
            if (!idVars.includes(columnName)) {
              const match = columnName.match(/^(.*\S)\s+(\d{4})$/);
              if (match) {
                const nilaiStr = row[columnName];
                const nilai_belanja = parseFloat(nilaiStr);
                if (!isNaN(nilai_belanja) && nilai_belanja > 0) {
                  longData.push({
                    "Nama Daerah": row["Nama Daerah"],
                    jenis_belanja: match[1].trim(),
                    tahun: match[2],
                    nilai_belanja: nilai_belanja,
                    first_digit: parseInt(nilaiStr[0], 10),
                    second_digit:
                      nilaiStr.length > 1 ? parseInt(nilaiStr[1], 10) : null,
                    first_two_digits:
                      nilaiStr.length > 1
                        ? parseInt(nilaiStr.substring(0, 2), 10)
                        : null,
                  });
                }
              }
            }
          });
        });
        if (longData.length === 0) {
          throw new Error(
            "Tidak ada data valid yang dapat diproses. Periksa format kolom dan nilai di CSV."
          );
        }
        return longData;
      }

      function populateFilters(data) {
        const uniqueBelanja = [
          ...new Set(data.map((item) => item.jenis_belanja)),
        ].sort();
        const uniqueTahun = [...new Set(data.map((item) => item.tahun))].sort();

        belanjaSelect.innerHTML = uniqueBelanja
          .map((b) => `<option value="${b}">${b}</option>`)
          .join("");
        tahunSelect.innerHTML = uniqueTahun
          .map((t) => `<option value="${t}">${t}</option>`)
          .join("");

        [analysisTypeSelect, belanjaSelect, tahunSelect, analyzeButton].forEach(
          (el) => {
            el.disabled = false;
          }
        );
      }

      function runAnalysis() {
        const loadingSpinner = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        buttonText.innerHTML = `${loadingSpinner} Menganalisis...`;
        analyzeButton.disabled = true;

        setTimeout(() => {
          try {
            const selectedType = analysisTypeSelect.value;
            const selectedBelanja = belanjaSelect.value;
            const selectedTahun = tahunSelect.value;

            let filteredData = processedData.filter(
              (d) =>
                d.jenis_belanja === selectedBelanja && d.tahun === selectedTahun
            );

            if (
              selectedType === "second_digit" ||
              selectedType === "first_two_digits"
            ) {
              filteredData = filteredData.filter((d) => d.nilai_belanja >= 10);
            }
            if (filteredData.length === 0) {
              alert(
                "Tidak ada data yang memenuhi kriteria untuk analisis ini."
              );
              return;
            }
            if (filteredData.length < 50) {
              alert(
                `Peringatan: Jumlah data hanya ${filteredData.length}. Hasil statistik mungkin kurang akurat.`
              );
            }

            const stats = calculateBenfordStats(filteredData, selectedType);
            updateUI(stats, selectedBelanja, selectedTahun, selectedType);
          } catch (error) {
            alert(`Error dalam analisis: ${error.message}`);
            console.error("Analysis error:", error);
          } finally {
            buttonText.textContent = "Tampilkan Analisis";
            analyzeButton.disabled = false;
          }
        }, 500);
      }

      function calculateBenfordStats(data, type) {
        const totalData = data.length;
        const distribution = benfordDistributions[type];
        const bins = Object.keys(distribution);
        const observedCounts = Object.fromEntries(bins.map((bin) => [bin, 0]));
        data.forEach((d) => {
          const key = d[type];
          if (observedCounts.hasOwnProperty(key)) {
            observedCounts[key]++;
          }
        });
        let madTotal = 0;
        let chiSquareTotal = 0;
        const zTestResults = {};
        const observedProps = {};
        bins.forEach((bin) => {
          const observedCount = observedCounts[bin];
          const observedProp = observedCount / totalData;
          observedProps[bin] = observedProp;
          const expectedProp = distribution[bin] / 100;
          const expectedCount = expectedProp * totalData;
          madTotal += Math.abs(observedProp - expectedProp);
          if (expectedCount > 0) {
            chiSquareTotal +=
              Math.pow(observedCount - expectedCount, 2) / expectedCount;
          }
          const z_denominator = Math.sqrt(
            (expectedProp * (1 - expectedProp)) / totalData
          );
          zTestResults[bin] =
            z_denominator > 0
              ? (observedProp - expectedProp) / z_denominator
              : 0;
        });
        const madResult = madTotal / criticalValues[type].mad_divisor;
        const significantZDigits = Object.keys(zTestResults).filter(
          (d) => zTestResults[d] > Z_CRITICAL_VALUE_ONE_SIDED
        );
        const anomalousRegions = {};
        if (significantZDigits.length > 0) {
          significantZDigits.forEach((digit) => {
            anomalousRegions[digit] = data
              .filter((d) => d[type] == digit)
              .map((d) => ({
                daerah: d["Nama Daerah"],
                nilai: d.nilai_belanja,
              }));
          });
        }
        return {
          totalData,
          observedProps,
          mad: madResult,
          chiSquare: chiSquareTotal,
          significantZDigits,
          anomalousRegions,
          type,
        };
      }

      function createBadge(text, color) {
        const colors = {
          green: "bg-green-500/10 text-green-400 border border-green-500/20",
          yellow:
            "bg-yellow-500/10 text-yellow-400 border border-yellow-500/20",
          red: "bg-red-500/10 text-red-400 border border-red-500/20",
        };
        return `<span class="ml-2 inline-block px-2 py-1 text-xs font-semibold rounded-full ${colors[color]}">${text}</span>`;
      }

      function updateUI(stats, belanja, tahun, type) {
        const typeName =
          analysisTypeSelect.options[analysisTypeSelect.selectedIndex].text;
        judulAnalisis.textContent = `Hasil Analisis (${typeName}): ${belanja} - Tahun ${tahun}`;

        let madConformity, madColor;
        if (stats.mad <= MAD_CLOSE_CONFORMITY) {
          madConformity = "Kecocokan Dekat";
          madColor = "green";
        } else if (stats.mad <= MAD_ACCEPTABLE_CONFORMITY) {
          madConformity = "Dapat Diterima";
          madColor = "yellow";
        } else {
          madConformity = "Tidak Cocok";
          madColor = "red";
        }
        hasilMad.innerHTML = `<strong class="text-slate-300">MAD:</strong> ${stats.mad.toFixed(
          6
        )} ${createBadge(madConformity, madColor)}`;

        const chiCritical = criticalValues[type].chi_square;
        const chiConformity =
          stats.chiSquare <= chiCritical ? "LOLOS" : "GAGAL";
        const chiColor = chiConformity === "LOLOS" ? "green" : "red";
        hasilChiSquare.innerHTML = `<strong class="text-slate-300">Uji Chi-Square (œá¬≤):</strong> ${stats.chiSquare.toFixed(
          4
        )} ${createBadge(chiConformity, chiColor)}`;

        if (stats.significantZDigits.length > 0) {
          hasilZTest.innerHTML = `<strong class="text-slate-300">Uji Z:</strong> Anomali signifikan pada angka: <strong class="text-sky-400">${stats.significantZDigits.join(
            ", "
          )}</strong>`;
        } else {
          hasilZTest.innerHTML = `<strong class="text-slate-300">Uji Z:</strong> Tidak ada anomali frekuensi signifikan.`;
        }

        daftarAnomaliContainer.innerHTML = "";
        if (Object.keys(stats.anomalousRegions).length > 0) {
          const list = document.createElement("ul");
          list.className = "space-y-2";
          Object.entries(stats.anomalousRegions).forEach(([digit, regions]) => {
            regions.forEach((r, index) => {
              const item = document.createElement("li");
              item.className =
                "p-3 bg-slate-700/50 rounded-lg text-sm transition-transform duration-200 hover:bg-slate-700 hover:scale-[1.03]";
              item.innerHTML = `
                    <div class="flex justify-between items-center">
                      <span class="font-medium text-slate-300">${
                        r.daerah
                      }</span>
                      <span class="text-xs font-mono bg-sky-500/10 text-sky-400 px-2 py-1 rounded">Angka ${digit}</span>
                    </div>
                    <div class="text-slate-400 text-xs mt-1">Nilai: ${r.nilai.toLocaleString(
                      "id-ID"
                    )}</div>`;
              list.appendChild(item);
            });
          });
          daftarAnomaliContainer.appendChild(list);
        } else {
          daftarAnomaliContainer.innerHTML = `<p class="text-center text-slate-400 italic py-4">‚úÖ Tidak ada anomali spesifik terdeteksi.</p>`;
        }

        renderChart(stats);

        // Show results with smooth transition
        hasilContainer.style.display = "block";
        setTimeout(() => {
          hasilContainer.classList.remove("opacity-0", "translate-y-8");
          hasilContainer.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 100);
      }

      function renderChart(stats) {
        const ctx = document.getElementById("benford-chart").getContext("2d");
        if (benfordChartInstance) {
          benfordChartInstance.destroy();
        }

        Chart.defaults.font.family = "sans-serif";

        benfordChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: Object.keys(benfordDistributions[stats.type]),
            datasets: [
              {
                label: "Observasi (%)",
                data: Object.keys(benfordDistributions[stats.type]).map(
                  (d) => stats.observedProps[d] * 100
                ),
                backgroundColor: "rgba(56, 189, 248, 0.6)",
                borderColor: "rgb(14, 165, 233)",
                borderWidth: 2,
                borderRadius: 6,
              },
              {
                label: "Hukum Benford (%)",
                data: Object.values(benfordDistributions[stats.type]),
                backgroundColor: "rgba(71, 85, 105, 0.6)",
                borderColor: "rgb(51, 65, 85)",
                borderWidth: 2,
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
                labels: { color: "#475569", font: { weight: "bold" } },
              },
              tooltip: {
                backgroundColor: "#0f172a",
                titleFont: { weight: "bold" },
                bodyFont: { size: 12 },
                callbacks: {
                  label: (c) => `${c.dataset.label}: ${c.parsed.y.toFixed(2)}%`,
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Frekuensi (%)",
                  color: "#475569",
                  font: { weight: "bold" },
                },
                grid: { color: "#e2e8f0" },
                ticks: { color: "#64748b" },
              },
              x: {
                title: {
                  display: true,
                  text: "Digit / Angka",
                  color: "#475569",
                  font: { weight: "bold" },
                },
                grid: { display: false },
                ticks: { color: "#64748b" },
              },
            },
            animation: { duration: 1500, easing: "easeOutCubic" },
            interaction: { intersect: false, mode: "index" },
          },
        });
      }
    </script>
  </body>
</html>
